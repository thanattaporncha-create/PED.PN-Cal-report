<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPN Order Report</title>
    <style>
        @page { margin: 20mm 10mm 10mm 10mm; size: A4; }

        body {
            font-family: 'Sarabun','Noto Sans Thai',Arial,sans-serif;
            font-size: 10pt; line-height: 1.3; color: #000;
            margin:0; padding:0; background:#fff;
        }

        .top-actions {
            position:fixed; top:20px; right:20px; z-index:1000;
            display:flex; gap:10px; flex-wrap:wrap;
        }
        .btn {
            background:#4facfe; color:white; border:none;
            padding:10px 16px; border-radius:25px;
            cursor:pointer; font-size:12px; font-weight:600;
            box-shadow:0 4px 12px rgba(79,172,254,0.4);
        }
        .btn:hover { background:#3b8ad6; }
        .btn.secondary {
            background:#718096;
            box-shadow:0 4px 12px rgba(113,128,150,0.4);
        }
        .btn.secondary:hover { background:#4a5568; }

        .report-container { max-width:210mm; margin:0 auto; padding:10mm; }

        .header {
            border-bottom:3px solid #4facfe; padding-bottom:8px;
            margin-bottom:12px; position:relative; padding-top:6px;
        }
        .header h1 {
            font-size:18pt; font-weight:700; color:#2d3748; margin:0 0 4px 0;
        }

        .order-date-special {
            background:#f0f9ff; border:2px solid #4facfe;
            padding:6px 10px; border-radius:6px;
            display:inline-flex; gap:8px; align-items:center;
            position:absolute; right:0; top:6px;
        }
        .order-date-special .date-info { font-size:10pt; font-weight:600; }
        .order-date-special .day-badge {
            background:#0369a1; color:white;
            padding:3px 10px; border-radius:20px;
            font-size:9pt; font-weight:600;
        }

        .section { margin-bottom:10px; }
        .section-title {
            background:#4facfe; color:white;
            padding:5px 10px; border-radius:4px;
            font-size:10pt; font-weight:600;
            margin-bottom:6px;
        }

        .info-grid {
            display:grid; grid-template-columns:1fr 1fr;
            gap:6px 20px; margin-bottom:8px;
        }
        .info-item { display:flex; gap:6px; }
        .info-label { font-weight:600; min-width:90px; }
        .info-value { color:#4a5568; }

        .route-badge {
            display:inline-block; padding:4px 12px;
            border-radius:20px; background:#10b981;
            color:white; font-weight:600; font-size:10pt;
        }
        .route-badge.peripheral { background:#f59e0b; }

        table { width:100%; border-collapse:collapse; }

        .composition-table th {
            background:#f8fafc; border:1px solid #e2e8f0;
            padding:5px 6px; font-weight:600;
        }
        .composition-table td {
            border:1px solid #e2e8f0; padding:4px 6px;
        }
        .highlight-row { background:#fef3c7 !important; }

        .input-badge {
            background:#e0f2fe; color:#0369a1; padding:2px 6px;
            border-radius:4px; font-size:8pt; font-weight:600;
        }

        .summary-table td, .summary-table th {
            border:1px solid #e2e8f0; padding:6px 8px;
        }
        .summary-table th { background:#f8fafc; width:55%; }

        .footer { margin-top:20px; text-align:center; font-size:9pt; color:#4a5568; }

        @media print {
            .top-actions { display:none; }
        }
    </style>
</head>
<body>

<div class="top-actions">
    <button class="btn secondary" onclick="goBack()">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    <button class="btn" onclick="saveAsImage()">üñºÔ∏è Save Image</button>
    <button class="btn" onclick="saveAsPDF()">üìÑ Save PDF</button>
</div>

<div id="report-root" class="report-container">

    <div class="header">
        <h1>üìã TPN Order Report</h1>
        <div class="order-date-special">
            <div class="date-info">üìÖ Order Date: <span id="display-order-date"></span></div>
            <div class="day-badge" id="display-day-name"></div>
        </div>
    </div>

    <!-- Patient Information -->
    <div class="section">
        <div class="section-title">üë§ Patient Information</div>
        <div class="info-grid">
            <div class="info-item"><span class="info-label">HN:</span><span id="display-hn"></span></div>
            <div class="info-item"><span class="info-label">Name:</span><span id="display-name"></span></div>
            <div class="info-item"><span class="info-label">Ward:</span><span id="display-ward"></span></div>
            <div class="info-item"><span class="info-label">Body Weight:</span><span id="display-bw"></span></div>
            <div class="info-item"><span class="info-label">Route:</span><span><span class="route-badge" id="display-route"></span></span></div>
        </div>
    </div>

    <!-- TPN Configuration -->
    <div class="section">
        <div class="section-title">üíß TPN Configuration</div>
        <div class="info-grid">
            <div class="info-item"><span class="info-label">Bag Volume:</span><span id="display-bag"></span></div>
            <div class="info-item"><span class="info-label">Rate:</span><span id="display-rate"></span></div>
        </div>
    </div>

    <!-- Composition -->
    <div class="section">
        <div class="section-title">üß™ TPN Composition</div>
        <table class="composition-table">
            <thead>
            <tr>
                <th style="width:35%;">Component</th>
                <th style="width:20%; text-align:center;">Dosage</th>
                <th style="width:20%; text-align:center;">Volume (ml)</th>
                <th style="width:25%; text-align:center;">Note</th>
            </tr>
            </thead>
            <tbody id="composition-body"></tbody>
        </table>
    </div>

    <!-- Summary -->
    <div class="section">
        <div class="section-title">üìä Summary</div>
        <table class="summary-table">
            <tr><th>Total PN Calories per day</th><td><span id="display-pn-cal"></span> kcal/day</td></tr>
            <tr><th>Total mOsmol/L</th><td><span id="display-osmol"></span></td></tr>
            <tr><th>From PN</th><td><span id="display-pn-total"></span> kcal/kg/day</td></tr>
            <tr><th>From Milk</th><td><span id="display-milk-total"></span> kcal/kg/day</td></tr>
            <tr><th>Total</th><td><span id="display-grand-total"></span> kcal/kg/day</td></tr>
        </table>
    </div>

    <div class="footer">
        Generated on <span id="generated-date"></span><br>
        ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô TPN Calculator for Pediatrics ¬© 2025
    </div>

</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function goBack() { window.location.href = 'index.html'; }

function loadData() {
    const d = JSON.parse(localStorage.getItem('tpnReportData') || '{}');

    const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    if (d.orderDate) {
        const date = new Date(d.orderDate);
        document.getElementById('display-order-date').textContent =
            `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear()+543}`;
    }

    document.getElementById('display-day-name').textContent = d.orderDayName || '-';
    document.getElementById('display-hn').textContent = d.hn || '-';
    document.getElementById('display-name').textContent = d.name || '-';
    document.getElementById('display-ward').textContent = d.ward || '-';
    document.getElementById('display-bw').textContent = d.bw ? `${d.bw} kg` : '-';

    const route = document.getElementById('display-route');
    if (d.route === 'peripheral') route.classList.add('peripheral');
    route.textContent = d.route === 'central' ? 'Central Line' : 'Peripheral Line';

    document.getElementById('display-bag').textContent = d.bag + ' ml';
    document.getElementById('display-rate').textContent = d.rate + ' ml/hr';

    document.getElementById('display-pn-cal').textContent = d.pnCalDay || '0';
    document.getElementById('display-pn-total').textContent = d.pnCalKg || '0';
    document.getElementById('display-milk-total').textContent = d.milkCalKg || '0';
    document.getElementById('display-grand-total').textContent = d.totalCalKg || '0';
    document.getElementById('display-osmol').textContent = '~' + d.totalOsmol;

    // composition
    const tbody = document.getElementById('composition-body');
    const addRow = (n, i, v, note='', highlight=false, isFat=false) => {
        const tr = document.createElement('tr');
        if (highlight) tr.classList.add('highlight-row');
        tr.innerHTML = `
            <td>${n}</td>
            <td style="text-align:center;"><span class="input-badge">${i}</span></td>
            <td style="text-align:center; font-weight:600; ${isFat ? 'color:#dc2626;' : ''}">${v} ml</td>
            <td style="text-align:center;">${note}</td>
        `;
        tbody.appendChild(tr);
    };

    if (+d.proteinVol > 0) addRow('10% Protein', `${d.protein} g/kg/day`, d.proteinVol);
    if (+d.dextroseVol > 0) addRow('50% Dextrose', `${d.dextrose}%`, d.dextroseVol);

    if (+d.pVol > 0) {
        addRow('Glycophos¬Æ (P)', `${d.p} mmol/kg/day`, d.pVol, `Contains Na ${d.naFromGly} mEq`);
    }

    if (d.naSource === 'nacl' && +d.naclVol > 0)
        addRow('3% NaCl', `${d.na} mEq/kg/day`, d.naclVol);
    if (d.naSource === 'na-acetate' && +d.naAcVol > 0)
        addRow('Na Acetate', `${d.na} mEq/kg/day`, d.naAcVol);

    if (d.kSource === 'kcl' && +d.kclVol > 0)
        addRow('15% KCl', `${d.k} mEq/kg/day`, d.kclVol);
    if (d.kSource === 'k-acetate' && +d.kAcVol > 0)
        addRow('K Acetate', `${d.k} mEq/kg/day`, d.kAcVol);

    if (+d.caVol > 0) addRow('Ca Gluconate', `${d.ca} mmol/kg/day`, d.caVol);
    if (+d.mgVol > 0) addRow('MgSO‚ÇÑ', `${d.mg} mmol/kg/day`, d.mgVol);

    if (+d.peditrace > 0) {
        let note = '';
        if (d.peditFreq === 'daily') note='Per day';
        else if (d.peditFreq === 'mwf') note='Mon Wed Fri';
        else note=`Weekly (${d.peditDay})`;
        addRow('Peditrace¬Æ','1 ml/kg/day',d.peditrace,note);
    }

    if (+d.cernevit > 0) {
        let note = '';
        if (d.cernFreq === 'daily') note='Per day';
        else if (d.cernFreq === 'mwf') note='Mon Wed Fri';
        else note=`Weekly (${d.cernDay})`;
        addRow('Cernevit¬Æ','1 ml/kg/day',d.cernevit,note);
    }

    if (d.vitKChoice !== 'none') {
        const v = d.vitKChoice === 'daily' ? d.vitKDaily : d.vitKWeekly;
        addRow('Vitamin K', d.vitKChoice==='daily'?'10 mcg/kg/day':'10 mcg/kg/week', v);
    }

    if (+d.fatVol > 0)
        addRow('20% Fat', `${d.fat} g/kg/day`, (+d.fatVol+6).toFixed(1), '(+6 ml)', false, true);

    if (+d.sterileWater > 0)
        addRow('Sterile Water', '-', d.sterileWater, '', true);

    const now = new Date();
    document.getElementById('generated-date').textContent =
        now.toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
}

async function captureReportCanvas() {
    const node = document.getElementById('report-root');
    return await html2canvas(node,{scale:2,backgroundColor:'#fff'});
}

async function saveAsPDF() {
    const canvas = await captureReportCanvas();
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');

    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;

    pdf.addImage(img,'PNG',0,10,w,h);
    pdf.save('TPN_Report.pdf');
}

async function saveAsImage() {
    const canvas = await captureReportCanvas();
    const imgData = canvas.toDataURL('image/png');

    const win = window.open();
    if (win && win.document) {
        win.document.write(`
        <html>
            <head><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>
            <body style="margin:0; background:#000; display:flex; justify-content:center; align-items:center;">
                <img src="${imgData}" style="width:100%; height:auto;" />
            </body>
        </html>`);
        win.document.close();
    } else {
        const link = document.createElement('a');
        link.href = imgData;
        link.download = 'TPN_Report.png';
        link.click();
    }
}

document.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
